name: Publish Release

on:
  push:
    tags:
      - '[0-9]+.[0-9]+.[0-9]+*'

permissions:
  contents: write
  pull-requests: write
  id-token: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Step 0: Extract version from tag
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  prepare:
    name: Prepare Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}
      is_rc: ${{ steps.get_version.outputs.is_rc }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: get_version
        run: |
          echo "========================================="
          echo "  Step 0: Extracting version from tag"
          echo "========================================="
          VERSION=${GITHUB_REF#refs/tags/}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "âœ… Extracted version: $VERSION"
          echo "   Git ref: $GITHUB_REF"
          echo "   SHA: $GITHUB_SHA"

          if [[ "$VERSION" =~ -rc\.[0-9]+$ ]]; then
            echo "is_rc=true" >> $GITHUB_OUTPUT
            echo "âœ… Detected RC (release candidate) version"
          else
            echo "is_rc=false" >> $GITHUB_OUTPUT
            echo "âœ… Detected stable release version"
          fi
          echo "========================================="

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Step 1: Update all versions (Android/iOS/JS)
  # This is done inside each publish job since they run on
  # different runners. The prepare job provides the version.
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Step 2: Publish Android, iOS, and npm packages in parallel
  #         (playground, sparkling-sdk, sparkling-app-template
  #          are NOT published here)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  # 2a. Publish TypeScript packages to npm
  publish-typescript:
    name: Publish NPM Packages
    runs-on: ubuntu-latest
    needs: prepare
    environment:
      name: package releasement
      url: https://www.npmjs.com/package/sparkling-sdk
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Log job start
        run: |
          echo "========================================="
          echo "  Step 2a: Publish NPM Packages"
          echo "========================================="
          echo "  Version: ${{ needs.prepare.outputs.version }}"
          echo "  Is RC:   ${{ needs.prepare.outputs.is_rc }}"
          echo "  Runner:  ${{ runner.os }} (${{ runner.arch }})"
          echo "========================================="

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          registry-url: 'https://registry.npmjs.org'

      - name: Ensure latest npm (>= 11.5.1 required for Trusted Publishing)
        run: |
          echo "ğŸ“¦ Upgrading npm for Trusted Publishing support..."
          npm install -g npm@latest
          echo "âœ… npm version: $(npm --version)"

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10.26.0

      - name: Install dependencies
        run: |
          echo "ğŸ“¦ Installing dependencies with frozen lockfile..."
          pnpm install --frozen-lockfile
          echo "âœ… Dependencies installed successfully"

      - name: Build packages
        run: |
          echo "ğŸ”¨ Building all packages (skipping website)..."
          pnpm --filter '!sparkling-website' -r build
          echo "âœ… All packages built successfully"

      - name: Update versions
        run: |
          echo "ğŸ“ Updating all versions to ${{ needs.prepare.outputs.version }}..."
          chmod +x scripts/update-all-version.sh
          ./scripts/update-all-version.sh ${{ needs.prepare.outputs.version }}
          echo "âœ… Versions updated successfully"

      - name: Check if npm packages already published
        id: npm_check
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          echo "ğŸ” Checking if npm packages are already published at version $VERSION..."
          # Check a representative package (sparkling-method is a core one)
          if npm view "sparkling-method@$VERSION" version 2>/dev/null | grep -q "$VERSION"; then
            echo "âš ï¸ sparkling-method@$VERSION already exists on npm â€” skipping publish"
            echo "::warning::npm packages at version $VERSION already published. Skipping."
            echo "already_published=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… Version $VERSION not found on npm â€” proceeding with publish"
            echo "already_published=false" >> $GITHUB_OUTPUT
          fi

      - name: Publish to npm
        if: steps.npm_check.outputs.already_published != 'true'
        env:
          NPM_CONFIG_PROVENANCE: 'true'
          SPARKLING_VERSION: ${{ needs.prepare.outputs.version }}
        run: |
          echo "ğŸš€ Publishing TypeScript packages to npm..."
          echo "   Version: ${{ needs.prepare.outputs.version }}"
          echo "   Is RC: ${{ needs.prepare.outputs.is_rc }}"
          echo "   Auth: Trusted Publishing (OIDC)"
          echo "   Provenance: enabled"
          if [ "${{ needs.prepare.outputs.is_rc }}" == "true" ]; then
            echo "   Tag: rc"
            node scripts/release-unify-and-publish.mjs publish --version ${{ needs.prepare.outputs.version }} --tag rc --trusted-publishing
          else
            echo "   Tag: latest"
            node scripts/release-unify-and-publish.mjs publish --version ${{ needs.prepare.outputs.version }} --release --trusted-publishing
          fi
          echo "âœ… TypeScript packages published successfully"

  # 2b. Publish Android to Maven Central
  publish-android:
    name: Publish Android to Maven Central
    runs-on: ubuntu-latest
    needs: prepare
    environment:
      name: package releasement
      url: https://central.sonatype.com/artifact/com.tiktok.sparkling/sparkling
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Log job start
        run: |
          echo "========================================="
          echo "  Step 2b: Publish Android to Maven Central"
          echo "========================================="
          echo "  Version: ${{ needs.prepare.outputs.version }}"
          echo "  Runner:  ${{ runner.os }} (${{ runner.arch }})"
          echo "========================================="

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Log JDK info
        run: |
          echo "â˜• JDK version:"
          java -version 2>&1
          echo "âœ… JDK setup complete"

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Update versions
        run: |
          echo "ğŸ“ Updating all versions to ${{ needs.prepare.outputs.version }}..."
          chmod +x scripts/update-all-version.sh
          ./scripts/update-all-version.sh ${{ needs.prepare.outputs.version }}
          echo "âœ… Versions updated successfully"

      - name: Verify Maven Central credentials
        env:
          MAVEN_CENTRAL_USERNAME: ${{ secrets.MAVEN_CENTRAL_USERNAME }}
          MAVEN_CENTRAL_PASSWORD: ${{ secrets.MAVEN_CENTRAL_PASSWORD }}
          SIGNING_KEY_ID: ${{ secrets.SIGNING_KEY_ID }}
          SIGNING_PASSWORD: ${{ secrets.SIGNING_PASSWORD }}
          SIGNING_KEY: ${{ secrets.SIGNING_KEY }}
        run: |
          echo "ğŸ”‘ Verifying Maven Central credentials..."
          MISSING=""
          [ -z "$MAVEN_CENTRAL_USERNAME" ] && MISSING="$MISSING MAVEN_CENTRAL_USERNAME"
          [ -z "$MAVEN_CENTRAL_PASSWORD" ] && MISSING="$MISSING MAVEN_CENTRAL_PASSWORD"
          [ -z "$SIGNING_KEY_ID" ] && MISSING="$MISSING SIGNING_KEY_ID"
          [ -z "$SIGNING_PASSWORD" ] && MISSING="$MISSING SIGNING_PASSWORD"
          [ -z "$SIGNING_KEY" ] && MISSING="$MISSING SIGNING_KEY"
          if [ -n "$MISSING" ]; then
            echo "âŒ Missing secrets:$MISSING"
            echo "::error::Missing Maven Central secrets:$MISSING"
            exit 1
          fi
          echo "âœ… All Maven Central credentials are present"
          echo "   Username length: ${#MAVEN_CENTRAL_USERNAME} chars"
          echo "   Signing Key ID: ${SIGNING_KEY_ID}"

      - name: Check if Android SDK already published
        id: maven_check
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          echo "ğŸ” Checking if Android SDK is already published at version $VERSION..."
          MAVEN_URL="https://repo1.maven.org/maven2/com/tiktok/sparkling/sparkling/$VERSION/sparkling-$VERSION.pom"
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$MAVEN_URL" 2>/dev/null || echo "000")
          if [ "$HTTP_STATUS" == "200" ]; then
            echo "âš ï¸ com.tiktok.sparkling:sparkling:$VERSION already exists on Maven Central â€” skipping publish"
            echo "::warning::Android SDK at version $VERSION already published on Maven Central. Skipping."
            echo "already_published=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… Version $VERSION not found on Maven Central (HTTP $HTTP_STATUS) â€” proceeding with publish"
            echo "already_published=false" >> $GITHUB_OUTPUT
          fi

      - name: Publish to Maven Central
        if: steps.maven_check.outputs.already_published != 'true'
        env:
          MAVEN_CENTRAL_USERNAME: ${{ secrets.MAVEN_CENTRAL_USERNAME }}
          MAVEN_CENTRAL_PASSWORD: ${{ secrets.MAVEN_CENTRAL_PASSWORD }}
          SIGNING_KEY_ID: ${{ secrets.SIGNING_KEY_ID }}
          SIGNING_PASSWORD: ${{ secrets.SIGNING_PASSWORD }}
          SIGNING_KEY: ${{ secrets.SIGNING_KEY }}
        run: |
          echo "ğŸš€ Publishing Android SDK to Maven Central..."
          echo "   Version: ${{ needs.prepare.outputs.version }}"
          chmod +x scripts/publish-android-maven.sh
          ./scripts/publish-android-maven.sh ${{ needs.prepare.outputs.version }} --skip-tests
          echo "âœ… Android SDK published to Maven Central successfully"

  # 2c. Publish iOS SparklingMethod to CocoaPods
  publish-ios-method:
    name: Publish iOS SparklingMethod
    runs-on: macos-latest
    needs: prepare
    environment:
      name: package releasement
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Log job start
        run: |
          echo "========================================="
          echo "  Step 2c: Publish iOS SparklingMethod"
          echo "========================================="
          echo "  Version: ${{ needs.prepare.outputs.version }}"
          echo "  Runner:  ${{ runner.os }} (${{ runner.arch }})"
          echo "========================================="

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'

      - name: Install CocoaPods
        run: |
          echo "ğŸ“¦ Installing CocoaPods..."
          gem install cocoapods
          pod setup
          echo "âœ… CocoaPods version: $(pod --version)"

      - name: Update versions
        run: |
          echo "ğŸ“ Updating all versions to ${{ needs.prepare.outputs.version }}..."
          chmod +x scripts/update-all-version.sh
          ./scripts/update-all-version.sh ${{ needs.prepare.outputs.version }}
          echo "âœ… Versions updated successfully"

      - name: Verify CocoaPods credentials
        env:
          COCOAPODS_TRUNK_TOKEN: ${{ secrets.COCOAPODS_TRUNK_TOKEN }}
        run: |
          echo "ğŸ”‘ Verifying CocoaPods trunk token..."
          if [ -z "$COCOAPODS_TRUNK_TOKEN" ]; then
            echo "âŒ COCOAPODS_TRUNK_TOKEN is empty!"
            echo "::error::COCOAPODS_TRUNK_TOKEN secret is missing or empty."
            exit 1
          fi
          TRUNK_INFO=$(COCOAPODS_TRUNK_TOKEN=$COCOAPODS_TRUNK_TOKEN pod trunk me 2>&1) || {
            echo "âŒ CocoaPods trunk authentication failed!"
            echo "::error::pod trunk me failed. Check that COCOAPODS_TRUNK_TOKEN is valid."
            echo "   Output: $TRUNK_INFO"
            exit 1
          }
          echo "âœ… CocoaPods trunk authentication successful:"
          echo "$TRUNK_INFO"

      - name: Check if SparklingMethod already published
        id: pod_method_check
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          echo "ğŸ” Checking if SparklingMethod is already published at version $VERSION..."
          if pod trunk info SparklingMethod 2>/dev/null | grep -q "$VERSION"; then
            echo "âš ï¸ SparklingMethod $VERSION already exists on CocoaPods â€” skipping publish"
            echo "::warning::SparklingMethod at version $VERSION already published. Skipping."
            echo "already_published=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… SparklingMethod $VERSION not found on CocoaPods â€” proceeding with publish"
            echo "already_published=false" >> $GITHUB_OUTPUT
          fi

      - name: Publish SparklingMethod to CocoaPods
        if: steps.pod_method_check.outputs.already_published != 'true'
        env:
          COCOAPODS_TRUNK_TOKEN: ${{ secrets.COCOAPODS_TRUNK_TOKEN }}
        run: |
          echo "ğŸš€ Publishing SparklingMethod to CocoaPods..."
          echo "   Version: ${{ needs.prepare.outputs.version }}"
          chmod +x scripts/publish-ios-sparkling-method.sh
          ./scripts/publish-ios-sparkling-method.sh ${{ needs.prepare.outputs.version }} --skip-git
          echo "âœ… SparklingMethod published to CocoaPods successfully"

  # 2d. Publish iOS Sparkling SDK to CocoaPods (depends on SparklingMethod)
  publish-ios-sdk:
    name: Publish iOS Sparkling SDK
    runs-on: macos-latest
    needs: [prepare, publish-ios-method]
    environment:
      name: package releasement
      url: https://cocoapods.org/pods/Sparkling
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Log job start
        run: |
          echo "========================================="
          echo "  Step 2d: Publish iOS Sparkling SDK"
          echo "========================================="
          echo "  Version: ${{ needs.prepare.outputs.version }}"
          echo "  Runner:  ${{ runner.os }} (${{ runner.arch }})"
          echo "  Depends: publish-ios-method (SparklingMethod)"
          echo "========================================="

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'

      - name: Install CocoaPods
        run: |
          echo "ğŸ“¦ Installing CocoaPods..."
          gem install cocoapods
          pod setup
          echo "âœ… CocoaPods version: $(pod --version)"

      - name: Update versions
        run: |
          echo "ğŸ“ Updating all versions to ${{ needs.prepare.outputs.version }}..."
          chmod +x scripts/update-all-version.sh
          ./scripts/update-all-version.sh ${{ needs.prepare.outputs.version }}
          echo "âœ… Versions updated successfully"

      - name: Wait for SparklingMethod CDN sync
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          echo "â³ Waiting for SparklingMethod $VERSION to be available on CDN..."
          FOUND=false
          for i in {1..30}; do
            if pod trunk info SparklingMethod 2>/dev/null | grep -q "$VERSION"; then
              echo "âœ… SparklingMethod $VERSION is available on CDN (after $i checks)"
              FOUND=true
              break
            fi
            echo "   Waiting... ($i/30, next check in 10s)"
            sleep 10
          done
          if [ "$FOUND" != "true" ]; then
            echo "âŒ SparklingMethod $VERSION was NOT found on CDN after 30 attempts (5 minutes)"
            echo "::error::SparklingMethod $VERSION not available on CocoaPods CDN after 5 minutes"
            exit 1
          fi

      - name: Check if Sparkling SDK already published
        id: pod_sdk_check
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          echo "ğŸ” Checking if Sparkling SDK is already published at version $VERSION..."
          if pod trunk info Sparkling 2>/dev/null | grep -q "$VERSION"; then
            echo "âš ï¸ Sparkling $VERSION already exists on CocoaPods â€” skipping publish"
            echo "::warning::Sparkling SDK at version $VERSION already published. Skipping."
            echo "already_published=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… Sparkling $VERSION not found on CocoaPods â€” proceeding with publish"
            echo "already_published=false" >> $GITHUB_OUTPUT
          fi

      - name: Publish Sparkling to CocoaPods
        if: steps.pod_sdk_check.outputs.already_published != 'true'
        env:
          COCOAPODS_TRUNK_TOKEN: ${{ secrets.COCOAPODS_TRUNK_TOKEN }}
        run: |
          echo "ğŸš€ Publishing Sparkling SDK to CocoaPods..."
          echo "   Version: ${{ needs.prepare.outputs.version }}"
          chmod +x scripts/publish-ios-sparkling.sh
          ./scripts/publish-ios-sparkling.sh ${{ needs.prepare.outputs.version }} --skip-wait --skip-git
          echo "âœ… Sparkling SDK published to CocoaPods successfully"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Step 3: Update sparkling-app-template dependencies and
  #         verify build succeeds
  # Step 4: Publish sparkling-app-template to npm
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  publish-template:
    name: Update & Publish App Template
    runs-on: macos-latest
    needs: [prepare, publish-typescript, publish-android, publish-ios-sdk]
    environment:
      name: package releasement
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Log job start
        run: |
          echo "========================================="
          echo "  Step 3+4: Update & Publish App Template"
          echo "========================================="
          echo "  Version: ${{ needs.prepare.outputs.version }}"
          echo "  Is RC:   ${{ needs.prepare.outputs.is_rc }}"
          echo "  Runner:  ${{ runner.os }} (${{ runner.arch }})"
          echo "  Depends: publish-typescript, publish-android, publish-ios-sdk"
          echo "========================================="

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          registry-url: 'https://registry.npmjs.org'

      - name: Ensure latest npm (>= 11.5.1 required for Trusted Publishing)
        run: |
          echo "ğŸ“¦ Upgrading npm for Trusted Publishing support..."
          npm install -g npm@latest
          echo "âœ… npm version: $(npm --version)"

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10.26.0

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'

      - name: Install CocoaPods
        run: |
          echo "ğŸ“¦ Installing CocoaPods..."
          gem install cocoapods
          pod setup
          echo "âœ… CocoaPods version: $(pod --version)"

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install dependencies
        run: |
          echo "ğŸ“¦ Installing workspace dependencies..."
          pnpm install --frozen-lockfile
          echo "âœ… Dependencies installed successfully"

      - name: Build packages
        run: |
          echo "ğŸ”¨ Building all packages (skipping website)..."
          pnpm --filter '!sparkling-website' -r build
          echo "âœ… All packages built successfully"

      # Step 3a: Update template version
      - name: Update all versions
        run: |
          echo "ğŸ“ [Step 3a] Updating all versions to ${{ needs.prepare.outputs.version }}..."
          chmod +x scripts/update-all-version.sh
          ./scripts/update-all-version.sh ${{ needs.prepare.outputs.version }}
          echo "âœ… Versions updated successfully"

      # Step 3b: Update npm dependencies in template package.json
      - name: Update template npm dependencies
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          TEMPLATE_PKG="template/sparkling-app-template/package.json"

          echo "ğŸ“ [Step 3b] Updating template npm dependencies..."
          echo "   File: $TEMPLATE_PKG"

          echo "   Updating sparkling-navigation -> ^${VERSION}"
          sed -i '' "s|\"sparkling-navigation\": *\"[^\"]*\"|\"sparkling-navigation\": \"^${VERSION}\"|" "$TEMPLATE_PKG"

          echo "   Updating sparkling-app-cli -> ~${VERSION}"
          sed -i '' "s|\"sparkling-app-cli\": *\"[^\"]*\"|\"sparkling-app-cli\": \"~${VERSION}\"|" "$TEMPLATE_PKG"

          echo ""
          echo "âœ… Updated template package.json:"
          cat "$TEMPLATE_PKG"

      # Step 3c: Update Android dependencies in build.gradle.kts
      - name: Update template Android dependencies
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          GRADLE_FILE="template/sparkling-app-template/android/app/build.gradle.kts"

          echo "ğŸ“ [Step 3c] Updating template Android dependencies..."
          echo "   File: $GRADLE_FILE"

          echo "   Updating com.tiktok.sparkling:sparkling -> ${VERSION}"
          sed -i '' "s|com.tiktok.sparkling:sparkling:[^\"]*|com.tiktok.sparkling:sparkling:${VERSION}|" "$GRADLE_FILE"

          echo "   Updating com.tiktok.sparkling:sparkling-method -> ${VERSION}"
          sed -i '' "s|com.tiktok.sparkling:sparkling-method:[^\"]*|com.tiktok.sparkling:sparkling-method:${VERSION}|" "$GRADLE_FILE"

          echo ""
          echo "âœ… Updated build.gradle.kts:"
          cat "$GRADLE_FILE"

      # Step 3d: Update iOS dependencies in Podfile
      - name: Update template iOS dependencies
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          PODFILE="template/sparkling-app-template/ios/Podfile"

          echo "ğŸ“ [Step 3d] Updating template iOS dependencies..."
          echo "   File: $PODFILE"

          echo "   Updating SPARKLING_VERSION -> '${VERSION}'"
          sed -i '' "s|SPARKLING_VERSION = '[^']*'|SPARKLING_VERSION = '${VERSION}'|" "$PODFILE"

          echo ""
          echo "âœ… Updated Podfile:"
          cat "$PODFILE"

      # Step 3e: Wait for npm packages to be available
      - name: Wait for npm packages availability
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          echo "â³ [Step 3e] Waiting for npm packages to be available..."
          ALL_FOUND=true
          for pkg in sparkling-navigation sparkling-app-cli; do
            echo ""
            echo "   Checking $pkg@$VERSION..."
            FOUND=false
            for i in {1..30}; do
              if npm view "$pkg@$VERSION" version 2>/dev/null | grep -q "$VERSION"; then
                echo "   âœ… $pkg@$VERSION is available on npm (after $i checks)"
                FOUND=true
                break
              fi
              echo "   Waiting for $pkg... ($i/30, next check in 10s)"
              sleep 10
            done
            if [ "$FOUND" != "true" ]; then
              echo "   âŒ $pkg@$VERSION was NOT found on npm after 30 attempts (5 minutes)"
              echo "::error::$pkg@$VERSION not available on npm after 5 minutes"
              ALL_FOUND=false
            fi
          done
          if [ "$ALL_FOUND" != "true" ]; then
            echo ""
            echo "âŒ Some npm packages are not available. Aborting."
            exit 1
          fi
          echo ""
          echo "âœ… All npm packages are available"

      # Step 3f: Verify JS build
      - name: Verify template JS build
        working-directory: template/sparkling-app-template
        run: |
          echo "ğŸ”¨ [Step 3f] Verifying template JS build..."
          echo "   Working directory: $(pwd)"
          echo ""
          echo "   Installing template dependencies..."
          pnpm install --no-frozen-lockfile
          echo ""
          echo "   Running build..."
          pnpm build
          echo ""
          echo "âœ… Template JS build succeeded!"

      # Step 3g: Verify Android build
      - name: Verify template Android build
        working-directory: template/sparkling-app-template/android
        run: |
          echo "ğŸ”¨ [Step 3g] Verifying template Android build..."
          echo "   Working directory: $(pwd)"
          echo ""
          chmod +x ./gradlew 2>/dev/null || true
          if ./gradlew assembleDebug --no-daemon; then
            echo ""
            echo "âœ… Template Android build succeeded!"
          else
            echo ""
            echo "âš ï¸ Template Android build failed!"
            echo "::warning::Android build verification failed - this may indicate dependency issues"
          fi

      # Step 3h: Verify iOS pod install
      - name: Wait for CocoaPods CDN sync
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          echo "â³ [Step 3h] Waiting for Sparkling pods to be available on CDN..."
          ALL_FOUND=true
          for pod_name in SparklingMethod Sparkling; do
            echo ""
            echo "   Checking $pod_name@$VERSION..."
            FOUND=false
            for i in {1..30}; do
              if pod trunk info "$pod_name" 2>/dev/null | grep -q "$VERSION"; then
                echo "   âœ… $pod_name $VERSION is available on CDN (after $i checks)"
                FOUND=true
                break
              fi
              echo "   Waiting for $pod_name... ($i/30, next check in 10s)"
              sleep 10
            done
            if [ "$FOUND" != "true" ]; then
              echo "   âŒ $pod_name $VERSION was NOT found on CDN after 30 attempts (5 minutes)"
              echo "::warning::$pod_name $VERSION not available on CocoaPods CDN after 5 minutes"
              ALL_FOUND=false
            fi
          done
          if [ "$ALL_FOUND" == "true" ]; then
            echo ""
            echo "âœ… All CocoaPods are available on CDN"
          else
            echo ""
            echo "âš ï¸ Some pods are not yet available on CDN, proceeding anyway..."
          fi

      - name: Verify template iOS pod install
        working-directory: template/sparkling-app-template/ios
        run: |
          echo "ğŸ”¨ [Step 3h] Verifying template iOS pod install..."
          echo "   Working directory: $(pwd)"
          echo ""
          if pod install; then
            echo ""
            echo "âœ… Template iOS pod install succeeded!"
          else
            echo ""
            echo "âš ï¸ Template iOS pod install failed!"
            echo "::warning::iOS pod install verification failed - this may indicate dependency issues"
          fi

      # Step 4: Publish sparkling-app-template to npm
      - name: Check if template already published
        id: template_check
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          echo "ğŸ” Checking if sparkling-app-template is already published at version $VERSION..."
          if npm view "sparkling-app-template@$VERSION" version 2>/dev/null | grep -q "$VERSION"; then
            echo "âš ï¸ sparkling-app-template@$VERSION already exists on npm â€” skipping publish"
            echo "::warning::sparkling-app-template at version $VERSION already published. Skipping."
            echo "already_published=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… sparkling-app-template@$VERSION not found on npm â€” proceeding with publish"
            echo "already_published=false" >> $GITHUB_OUTPUT
          fi

      - name: Publish template to npm
        if: steps.template_check.outputs.already_published != 'true'
        working-directory: template/sparkling-app-template
        env:
          NPM_CONFIG_PROVENANCE: 'true'
        run: |
          echo "ğŸš€ [Step 4] Publishing sparkling-app-template to npm..."
          echo "   Version: ${{ needs.prepare.outputs.version }}"
          echo "   Working directory: $(pwd)"
          echo "   Auth: Trusted Publishing (OIDC)"
          echo "   Provenance: enabled"
          echo ""
          if [ "${{ needs.prepare.outputs.is_rc }}" == "true" ]; then
            echo "   Tag: rc"
            pnpm publish --registry https://registry.npmjs.org --access public --tag rc --no-git-checks
          else
            echo "   Tag: latest"
            pnpm publish --registry https://registry.npmjs.org --access public --tag latest --no-git-checks
          fi
          echo ""
          echo "âœ… sparkling-app-template published to npm successfully"

      # Step 4b: Create PR to update template dependencies in main branch
      - name: Create branch and commit template updates
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          BRANCH="chore/update-template-deps-${VERSION}"

          echo "ğŸ“ [Step 4b] Creating PR to update template dependencies..."
          echo "   Branch: $BRANCH"
          echo "   Version: $VERSION"
          echo ""

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Create a new branch from the current tag
          git checkout -b "$BRANCH"

          # Re-apply the template dependency changes (they were done in working tree earlier)
          # Update template package.json
          TEMPLATE_PKG="template/sparkling-app-template/package.json"
          sed -i '' "s|\"sparkling-navigation\": *\"[^\"]*\"|\"sparkling-navigation\": \"^${VERSION}\"|" "$TEMPLATE_PKG"
          sed -i '' "s|\"sparkling-app-cli\": *\"[^\"]*\"|\"sparkling-app-cli\": \"~${VERSION}\"|" "$TEMPLATE_PKG"

          # Update Android build.gradle.kts
          GRADLE_FILE="template/sparkling-app-template/android/app/build.gradle.kts"
          sed -i '' "s|com.tiktok.sparkling:sparkling:[^\"]*|com.tiktok.sparkling:sparkling:${VERSION}|" "$GRADLE_FILE"
          sed -i '' "s|com.tiktok.sparkling:sparkling-method:[^\"]*|com.tiktok.sparkling:sparkling-method:${VERSION}|" "$GRADLE_FILE"

          # Update iOS Podfile
          PODFILE="template/sparkling-app-template/ios/Podfile"
          sed -i '' "s|SPARKLING_VERSION = '[^']*'|SPARKLING_VERSION = '${VERSION}'|" "$PODFILE"

          # Also update root and SDK package.json versions via the version script
          chmod +x scripts/update-all-version.sh
          ./scripts/update-all-version.sh "$VERSION"

          # Stage and commit
          git add -A
          if git diff --cached --quiet; then
            echo "âš ï¸ No changes to commit - template dependencies may already be up to date"
          else
            git commit -m "chore: update template dependencies to ${VERSION}"
            echo "âœ… Changes committed"

            echo ""
            echo "   Pushing branch to origin..."
            git push origin "$BRANCH"
            echo "âœ… Branch pushed to origin"

            echo ""
            echo "   Creating pull request..."
            PR_BODY=$(cat <<'PREOF'
          ## Summary

          Auto-generated by the publish workflow after releasing version.

          Updates `sparkling-app-template` dependencies to match the published versions:

          - **TypeScript** (`template/sparkling-app-template/package.json`):
            - `sparkling-navigation`
            - `sparkling-app-cli`
          - **Android** (`template/sparkling-app-template/android/app/build.gradle.kts`):
            - `com.tiktok.sparkling:sparkling`
            - `com.tiktok.sparkling:sparkling-method`
          - **iOS** (`template/sparkling-app-template/ios/Podfile`):
            - `SPARKLING_VERSION`
          - **Root & SDK versions** aligned

          > This PR was created automatically by GitHub Actions.
          PREOF
          )
            # Replace generic text with actual version
            PR_BODY="${PR_BODY//releasing version/releasing version \`${VERSION}\`}"

            PR_URL=$(gh pr create \
              --title "chore: update template dependencies to ${VERSION}" \
              --body "$PR_BODY" \
              --base main \
              --head "$BRANCH" 2>&1) || {
              echo "âŒ Failed to create PR!"
              echo "::error::Failed to create pull request for template dependency updates"
              echo "   Output: $PR_URL"
              exit 0  # Don't fail the whole job just because PR creation failed
            }
            echo "âœ… Pull request created: $PR_URL"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Step 5: Create GitHub Release
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [prepare, publish-template]
    if: always() && needs.prepare.result == 'success'
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Log job start
        run: |
          echo "========================================="
          echo "  Step 5: Create GitHub Release"
          echo "========================================="
          echo "  Version: ${{ needs.prepare.outputs.version }}"
          echo "  Is RC:   ${{ needs.prepare.outputs.is_rc }}"
          echo "========================================="

      - name: Determine release status
        id: status
        run: |
          echo "ğŸ“‹ Checking publish job results..."
          TEMPLATE_RESULT="${{ needs.publish-template.result }}"
          echo "   publish-template: $TEMPLATE_RESULT"

          if [ "$TEMPLATE_RESULT" == "success" ]; then
            echo "all_success=true" >> $GITHUB_OUTPUT
            echo "âœ… All publish jobs succeeded - creating release"
          else
            echo "all_success=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ Some publish jobs failed - creating draft release"
            echo "::warning::Not all publish jobs succeeded. Release will be created as draft."
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: Release ${{ needs.prepare.outputs.version }}
          draft: ${{ needs.prepare.outputs.is_rc == 'true' || steps.status.outputs.all_success != 'true' }}
          prerelease: ${{ needs.prepare.outputs.is_rc == 'true' }}
          generate_release_notes: true
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Log release result
        run: |
          echo "========================================="
          if [ "${{ needs.prepare.outputs.is_rc }}" == "true" ]; then
            echo "âœ… Draft pre-release created for ${{ needs.prepare.outputs.version }}"
          elif [ "${{ steps.status.outputs.all_success }}" == "true" ]; then
            echo "âœ… Release created for ${{ needs.prepare.outputs.version }}"
          else
            echo "âš ï¸ Draft release created for ${{ needs.prepare.outputs.version }} (some jobs failed)"
          fi
          echo "========================================="

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Notify on failure
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [prepare, publish-typescript, publish-android, publish-ios-method, publish-ios-sdk, publish-template]
    if: failure()
    steps:
      - name: Report failure details
        run: |
          echo "========================================="
          echo "  âŒ PUBLISH WORKFLOW FAILED"
          echo "========================================="
          echo ""
          echo "  Version: ${{ needs.prepare.outputs.version }}"
          echo ""
          echo "  Job Results:"
          echo "    prepare:            ${{ needs.prepare.result }}"
          echo "    publish-typescript: ${{ needs.publish-typescript.result }}"
          echo "    publish-android:    ${{ needs.publish-android.result }}"
          echo "    publish-ios-method: ${{ needs.publish-ios-method.result }}"
          echo "    publish-ios-sdk:    ${{ needs.publish-ios-sdk.result }}"
          echo "    publish-template:   ${{ needs.publish-template.result }}"
          echo ""
          echo "  Please check the individual job logs above for details."
          echo "========================================="
          echo ""
          echo "::error::Publishing failed for version ${{ needs.prepare.outputs.version }}. See job results above."
